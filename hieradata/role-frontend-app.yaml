---
classes:
  - 'nginx::server'
  - 'performanceplatform::assets'
  - 'phantomjs'
  - 'screenshot_as_a_service::app'
  - 'spotlight::app'
  - 'varnish'
  - 'stagecraft::assets'

# screenshot_as_a_service runs on 3059 and 3060, but 3059
# is only used from within this app.
screenshot_as_a_service::app::port:       3060
screenshot_as_a_service::app::app_module: 'screenshot_as_a_service:app'
screenshot_as_a_service::app::user:       'deploy'
screenshot_as_a_service::app::group:      'deploy'

spotlight::app::port:       3057
spotlight::app::app_module: 'spotlight:app'
spotlight::app::user:       'deploy'
spotlight::app::group:      'deploy'

ufw_rules:
  allow-http-from-anywhere:
    port: 80
    ip:   'any'
  allow-https-from-anywhere:
    port: 443
    ip:   'any'

vhost_proxies:
  assets-varnish-vhost:
    servername:    "%{::assets_vhost}"
    ssl:           true
    ssl_redirect:  true
    upstream_port: 7999
    access_logs:
      '{name}.access.log.json': 'json_event'
    four_warning: 1
    four_critical: 3
    five_warning: 0
    five_critical: 1
    denied_http_verbs:
      - PURGE

  admin-vhost:
    servername:    "%{::admin_vhost}"
    ssl:           true
    ssl_redirect:  true
    upstream_port: 7999
    access_logs:
      '{name}.access.log.json': 'json_event'
    four_warning: 1
    four_critical: 3
    five_warning: 0
    five_critical: 1
    denied_http_verbs:
      - PURGE

  www-vhost:
    servername:    "%{::www_vhost}"
    ssl:           true
    ssl_redirect:  true
    upstream_port: 7999
    access_logs:
      '{name}.access.log.json': 'json_event'
    four_warning: 1
    four_critical: 3
    five_warning: 0
    five_critical: 1
    client_max_body_size: '30m'
    magic: |
      gzip on;
      gzip_types application/x-javascript application/javascript application/json text/css;
      gzip_proxied no_etag;
      gzip_vary on;
    denied_http_verbs:
      - PURGE

  stagecraft-vhost:
    servername:    "%{::stagecraft_vhost}"
    ssl:           true
    ssl_redirect:  true
    upstream_port: 7999
    access_logs:
      '{name}.access.log.json': 'json_event'
    four_warning: 1
    four_critical: 3
    five_warning: 0
    five_critical: 1
    pp_only_vhost: true
    denied_http_verbs:
      - PURGE

nginx::server::server_names_hash_bucket_size: 128

nginx_conf:
  logging:
    template: performanceplatform/nginx.logging.conf.erb

lumberjack_instances:
  nginx:
    log_files: [ '/var/log/nginx/*.access.log.json' ]
  varnish:
    log_files: [ '/var/log/varnish/varnishncsa.log' ]

system_packages:
  - libcairo2-dev
  - libjpeg8-dev
  - libpango1.0-dev
  - libgif-dev
